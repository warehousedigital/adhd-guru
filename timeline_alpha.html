<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Overwhelm â†’ Action Converter</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/marked/marked.min.css">
  <style>
    body {
      font-family: sans-serif;
      background-color: #1e1e1e;
      color: #f0f0f0;
      padding: 2rem;
      max-width: 700px;
      margin: 0 auto;
    }
    h1 {
      color: #f8f8f8;
      font-size: 1.8rem;
    }
    .intro {
      margin: 1rem 0;
      font-size: 1rem;
      line-height: 1.6;
      color: #ccc;
    }
    textarea, input, select, button {
      width: 100%;
      margin: 0.5rem 0 1rem 0;
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: 0.4rem;
      border: 1px solid #444;
      background-color: #2a2a2a;
      color: #f0f0f0;
      box-sizing: border-box;
      line-height: 1.4;
    }
    button {
      background: #3b3b3b;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover:enabled {
      background: #555;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .inline {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .inline input[type="number"] {
      flex: 2;
      min-width: 120px;
    }
    .inline select {
      flex: 1;
      min-width: 120px;
    }
    .char-count {
      text-align: right;
      font-size: 0.9rem;
      color: #ccc;
      margin-top: -0.5rem;
      margin-bottom: 1rem;
    }
    .char-count.full {
      color: red;
    }
    details {
      margin-top: 1rem;
      background: #2e2e2e;
      border-radius: 0.5rem;
      padding: 1rem;
    }
    summary {
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 1rem;
    }
    .output {
      background: #2e2e2e;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      margin-top: 1rem;
      position: relative;
    }
    .spinner {
      border: 4px solid #333;
      border-top: 4px solid #f0f0f0;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 1rem auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .controls {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    .controls button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      color: #ccc;
    }
    .error {
      color: #ff6b6b;
    }
      .error {
    color: #ff6b6b;
  }

  /* ðŸ‘‡ Add this at the very end */
  #loadingMsg {
    text-align: center;
    margin-top: 1rem;
    font-size: 1rem;
    color: #ccc;
  }
  </style>
</head>
<body>
  
    <!-- Consent Modal -->
  <div id="welcomeModal" style="
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  ">
    <div style="background: #222; padding: 2rem; border-radius: 1rem; max-width: 500px; text-align: center;">
      <h2>Welcome to Overwhelm â†’ Action Converter</h2>
      <p>This is an early Alpha version of the tool. Please read and accept the privacy policy and terms of use before continuing.</p>
      <p><strong>Do you agree to the terms and wish to continue?</strong></p>
      <div style="margin-top: 1.5rem;">
        <button onclick="handleConsent(true)" style="margin-right: 1rem;">Agree</button>
        <button onclick="handleConsent(false)">Disagree</button>
      </div>
    </div>
  </div>
  
  <h1>ðŸ§  Overwhelm â†’ Action Converter</h1>
  <p class="intro">Feeling overwhelmed or anxious? This simple tool turns everything you type into a clear, realistic plan based on how much time you have. Itâ€™s fast, kind, and built to help you get unstuck.</p>

  <textarea id="freeform" maxlength="1000" rows="7" placeholder="Whatâ€™s on your mind? Tell me what you need to do, whatâ€™s bothering you, and what matters most right now."></textarea>
  <div id="charCount" class="char-count">0 / 1000</div>

  <label>Roughly how much time do you have to work with?</label>
  <div class="inline">
    <input type="number" id="timeAmount" min="1" placeholder="e.g. 3" />
    <select id="timeUnit">
      <option value="minutes">Minutes</option>
      <option value="hours">Hours</option>
      <option value="days">Days (8 working hours)</option>
    </select>
  </div>
  <button id="mainPlanButton" onclick="submitToAI()">Make My Plan</button>

  <div id="responses"></div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    let promptHistory = [];

    const freeform = document.getElementById("freeform");
    const charCount = document.getElementById("charCount");
    freeform.addEventListener("input", () => {
      const len = freeform.value.length;
      charCount.textContent = `${len} / 1000`;
      if (len >= 1000) {
        charCount.classList.add("full");
        freeform.title = "You've reached the maximum character limit.";
        freeform.value = freeform.value.substring(0, 1000);
      } else {
        charCount.classList.remove("full");
        freeform.removeAttribute("title");
      }
    });

async function submitToAI() {
  const responsesDiv = document.getElementById("responses");
  const text = freeform.value.trim();
  const amount = document.getElementById("timeAmount").value.trim();
  const unit = document.getElementById("timeUnit").value;

  if (!text || !amount || isNaN(amount)) {
    responsesDiv.innerHTML = "<p class='error'>Please enter your thoughts and how much time you have.</p>";
    return;
  }

  let adjustedHours = unit === "minutes" ? (parseFloat(amount) / 60) : unit === "days" ? parseFloat(amount) * 8 : parseFloat(amount);
  const now = new Date();
  const localTimeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const localDateString = now.toLocaleDateString([], { weekday: 'long' });
  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const locale = navigator.language || 'en-GB';
  const userTimeInfo = `User info: Local time is approximately ${localTimeString} on ${localDateString}. Timezone - ${timezone}, Locale - ${locale}`;

  const prompt = `You are a task planning assistant helping someone with ADHD and executive dysfunction. Be kind, encouraging and understanding, but not overly sweet or jokey. Speak plainly and helpfully, as if from someone grounded and empathetic. Use UK spelling and grammar.\n\nHere's what they said:\n\n"${text}"\n\nThey have about ${adjustedHours} hours available. Use this to generate a well-paced, realistic timeline that includes hydration, rest, and food if needed.\n\n${userTimeInfo}\n\nUse markdown formatting: headings (#), bold (**bold**), and lists. Respond in clear, encouraging language.`;

  const container = document.createElement("details");
  container.className = "output";
  container.open = true;
  const spinnerId = `spinner-${Date.now()}`;
  container.innerHTML = `<summary>ðŸ“„ Timeline Plan</summary>
    <div id="${spinnerId}" class='spinner'></div>
    <p id="loadingMsg">Generating your action plan...</p>`;
  responsesDiv.appendChild(container);

  const loadingMsg = document.getElementById("loadingMsg");
  let msgUpdate1 = setTimeout(() => loadingMsg.textContent = "Almost there...", 6000);
  let msgUpdate2 = setTimeout(() => loadingMsg.textContent = "Just tying up loose ends...", 12000);
  let timeoutAbort = setTimeout(() => {
    localStorage.setItem("recoveredText", text);
    alert("Somethingâ€™s gone wrong!\nWeâ€™ve copied your text into a fresh page for you to try again.");
    location.reload();
  }, 120000); // 2 minutes

  try {
    // simulate long wait for testing purposes:
    await new Promise(resolve => setTimeout(resolve, 130000));
    throw new Error("Simulated stuck response");

    // âœ… in real use, you'd replace the two lines above with:
    // const response = await fetch("https://shy-poetry-c035.peter-775.workers.dev", {
    //   method: "POST",
    //   headers: { "Content-Type": "application/json" },
    //   body: JSON.stringify({ input: prompt })
    // });
    // const data = await response.json();

    const formatted = marked.parse(data.plan);

    clearTimeout(msgUpdate1);
    clearTimeout(msgUpdate2);
    clearTimeout(timeoutAbort);

    const controls = `
      <div class="controls">
        <button onclick="copyText(this)">ðŸ“‹</button>
        <button onclick="downloadText(this)">ðŸ’¾</button>
      </div>
    `;
    const inner = document.createElement("div");
    inner.innerHTML = `${controls}${formatted}`;
    container.innerHTML = `<summary>ðŸ“„ Timeline Plan</summary>`;
    container.appendChild(inner);

    const responseBox = document.createElement("textarea");
    responseBox.rows = 3;
    responseBox.placeholder = "Have any other questions or want to change some details? Type your response here.";

    const sendBtn = document.createElement("button");
    sendBtn.textContent = "Send Response";
    sendBtn.onclick = () => {
      sendBtn.disabled = true;
      responseBox.disabled = true;
      container.open = false;
    };

    container.appendChild(responseBox);
    container.appendChild(sendBtn);

  } catch (err) {
    clearTimeout(msgUpdate1);
    clearTimeout(msgUpdate2);
    clearTimeout(timeoutAbort);
    container.innerHTML = `<summary>Error</summary><p class='error'>Error: ${err.message}</p>`;
  }
}

    function copyText(btn) {
      const text = btn.closest(".output").innerText;
      navigator.clipboard.writeText(text).then(() => {
        const note = document.createElement("span");
        note.textContent = "Copied to clipboard!";
        note.style.marginLeft = "0.5rem";
        note.style.color = "#90ee90";
        btn.parentNode.appendChild(note);
        setTimeout(() => note.remove(), 2000);
      });
    }

    function downloadText(btn) {
      const text = btn.closest(".output").innerText;
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const now = new Date();
      const dateStr = now.toLocaleDateString("en-GB").replace(/\//g, "-");
      const timeStr = now.toTimeString().slice(0, 5).replace(":", "-");
      a.download = `My Timeline ${dateStr} ${timeStr}.txt`;
      a.href = url;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function handleConsent(agreed) {
  if (agreed) {
    localStorage.setItem("userAgreedToTerms", "true");
    document.getElementById("welcomeModal").style.display = "none";
  } else {
    window.location.href = "https://www.google.com";
  }
}
    
    window.addEventListener("DOMContentLoaded", () => {
  const hasAgreed = localStorage.getItem("userAgreedToTerms");
  if (hasAgreed !== "true") {
    document.getElementById("welcomeModal").style.display = "flex";
  } else {
    document.getElementById("welcomeModal").style.display = "none";
  }
      
      const recovered = localStorage.getItem("recoveredText");
if (recovered) {
  document.getElementById("freeform").value = recovered;
  document.getElementById("charCount").textContent = `${recovered.length} / 1000`;
  localStorage.removeItem("recoveredText");
}
});

  </script>
</body>
</html>
