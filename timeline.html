<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mental Dump â†’ Timeline</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      padding: 2rem;
      max-width: 700px;
      margin: 0 auto;
    }
    h1 {
      color: #2c3e50;
      font-size: 1.8rem;
    }
    .intro {
      margin: 1rem 0;
      font-size: 1rem;
      line-height: 1.6;
      color: #333;
    }
    textarea, input, select, button {
      width: 100%;
      margin: 0.5rem 0 1rem 0;
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: 0.4rem;
      border: 1px solid #ccc;
      box-sizing: border-box;
      line-height: 1.4;
    }
    button {
      background: #2c3e50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover:enabled {
      background: #1a242f;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .inline {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .inline input[type="number"] {
      flex: 2;
      min-width: 120px;
    }
    .inline select {
      flex: 1;
      min-width: 120px;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      margin: 0;
    }
    .char-count {
      text-align: right;
      font-size: 0.9rem;
      color: #666;
      margin-top: -0.5rem;
      margin-bottom: 1rem;
    }
    .char-count.full {
      color: red;
    }
    .output {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      margin-top: 1rem;
      position: relative;
    }
    .loading {
      font-style: italic;
      color: #999;
      text-align: center;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2c3e50;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 1rem auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .controls {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    .controls button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
    }
    details summary {
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    .faded {
      opacity: 0.6;
      pointer-events: none;
    }
  details[open] > summary::after {
      content: "â–²";
      float: right;
    }
    details > summary::after {
      content: "â–¼";
      float: right;
    }
    details[open] > *:not(summary) {
      animation: fadeOut 0.3s ease-in-out;
    }
    @keyframes fadeOut {
      0% { opacity: 0; max-height: 0; }
      100% { opacity: 1; max-height: 1000px; }
    }
  .output h1,
    .output h2,
    .output h3 {
      margin-top: 1rem;
      margin-bottom: 0.25rem;
    }
    .output p {
      margin: 0.25rem 0;
    }
    .output ul,
    .output ol {
      margin: 0.25rem 0 0.5rem 1.5rem;
      padding-left: 1rem;
    }

    body {
      background-color: #1e1e1e;
      color: #f0f0f0;
    }
    textarea, input, select, button {
      background-color: #2a2a2a;
      color: #f0f0f0;
      border: 1px solid #444;
    }
    .intro, .char-count, label, summary {
      color: #ccc;
    }
    button {
      background-color: #3b3b3b;
      color: #fff;
    }
    button:hover:enabled {
      background-color: #555;
    }
    .output {
      background: #2e2e2e;
    }
    .spinner {
      border: 4px solid #333;
      border-top: 4px solid #f0f0f0;
    }
    .controls button {
      color: #ccc;
    }
    .error {
      color: #ff6b6b;
    }
  </style>
<style>
  body {
    font-family: sans-serif;
    background-color: #1e1e1e;
    color: #e0e0e0;
  }
  textarea, input, select, button {
    background-color: #2b2b2b;
    color: #f0f0f0;
    border: 1px solid #555;
  }
  .intro, .char-count, label, summary {
    color: #cccccc;
  }
  button {
    background-color: #3c3c3c;
    color: #ffffff;
  }
  button:hover:enabled {
    background-color: #555555;
  }
  .output {
    background: #2a2a2a;
    color: #f0f0f0;
  }
  .output h1, .output h2, .output h3 {
    color: #ffdc91;
  }
  .output p {
    color: #dddddd;
    margin: 0.25rem 0;
  }
  .output ul, .output ol {
    margin: 0.25rem 0 0.5rem 1.5rem;
    padding-left: 1rem;
  }
  .spinner {
    border: 4px solid #333;
    border-top: 4px solid #f0f0f0;
  }
  .controls button {
    color: #cccccc;
  }
  .error {
    color: #ff6b6b;
  }
</style>
<script>
  function toggleTheme() {
    const styleTag = document.getElementById('theme-style');
    const isDark = document.body.dataset.theme === 'dark';
    document.body.dataset.theme = isDark ? 'light' : 'dark';
    styleTag.innerHTML = isDark ? `
      body {
        font-family: sans-serif;
        background-color: #f5f5f5;
        color: #111;
      }
      textarea, input, select, button {
        background-color: #fff;
        color: #111;
        border: 1px solid #ccc;
      }
      .intro, .char-count, label, summary {
        color: #333;
      }
      button {
        background-color: #2c3e50;
        color: #fff;
      }
      button:hover:enabled {
        background-color: #1a242f;
      }
      .output {
        background: #fff;
      }
      .spinner {
        border: 4px solid #ddd;
        border-top: 4px solid #2c3e50;
      }
      .controls button {
        color: #333;
      }
      .error {
        color: red;
      }
    ` : `
      body {
        font-family: sans-serif;
        background-color: #1e1e1e;
        color: #f0f0f0;
      }
      textarea, input, select, button {
        background-color: #2a2a2a;
        color: #f0f0f0;
        border: 1px solid #444;
      }
      .intro, .char-count, label, summary {
        color: #ccc;
      }
      button {
        background-color: #3b3b3b;
        color: #fff;
      }
      button:hover:enabled {
        background-color: #555;
      }
      .output {
        background: #2e2e2e;
      }
      .spinner {
        border: 4px solid #333;
        border-top: 4px solid #f0f0f0;
      }
      .controls button {
        color: #ccc;
      }
      .error {
        color: #ff6b6b;
      }`;
  }
</script>
</head>
<body>

  <h1>ðŸ§  Mental Dump â†’ Timeline</h1>
  <p class="intro">Feeling overwhelmed? This tool turns everything in your head into a clear, time-based plan that actually works for you. The more detail you give â€“ tasks, worries, priorities â€“ the better it can shape a plan that fits.</p>

  <details id="inputDetails" open>
    <summary>ðŸ“¥ Show/Hide Your Original Input</summary>
    <div id="initialInputs">
      <label for="freeform">Whatâ€™s on your mind?</label>
      <textarea id="freeform" maxlength="1000" rows="7" placeholder="Need to book a dentist appointment, reply to at least 3 emails, and finally make a start on that big project. Washingâ€™s piling up. Havenâ€™t exercised in ages â€” keep saying Iâ€™ll go for a run but never do. Kitchenâ€™s a mess and Iâ€™ve barely eaten anything proper today. Feeling behind on everything. Not sure how long Iâ€™ve got to do all this, but I need to make some progress today."></textarea>
      <div id="charCount" class="char-count">0 / 1000</div>

      <label>How much time do you have?</label>
      <div class="inline">
        <input type="number" id="timeAmount" min="1" placeholder="e.g. 3" />
        <select id="timeUnit">
          <option value="minutes">Minutes</option>
          <option value="hours">Hours</option>
          <option value="days">Days (8 working hours)</option>
        </select>
      </div>

      <button id="mainPlanButton" onclick="submitToAI()">Make My Plan</button>
    </div>
  </details>

  <div id="responses"></div>

  <script>
    let promptHistory = [];
    let hasFollowedUp = false;

    const freeform = document.getElementById("freeform");
    const charCount = document.getElementById("charCount");
    if (freeform && charCount) {
      freeform.addEventListener("input", () => {
        const len = freeform.value.length;
        charCount.textContent = `${len} / 1000`;
        if (len >= 1000) {
          charCount.classList.add("full");
          freeform.title = "You've reached the maximum character limit.";
          freeform.value = freeform.value.substring(0, 1000);
        } else {
          charCount.classList.remove("full");
          freeform.removeAttribute("title");
        }
      });
    }

    async function submitToAI(followUpText = null, fromFollowUp = false, triggerEl = null) {
      const responsesDiv = document.getElementById("responses");
      const text = document.getElementById("freeform")?.value?.trim() || "";
      const amount = document.getElementById("timeAmount")?.value?.trim() || "";
      const unit = document.getElementById("timeUnit")?.value || "";

      if (!followUpText && (!text || !amount || isNaN(amount))) {
        responsesDiv.innerHTML = "<p class='error'>Please enter your thoughts and how much time you have.</p>";
        return;
      }

      let adjustedHours;
      if (unit === "minutes") adjustedHours = (parseFloat(amount) / 60).toFixed(2);
      else if (unit === "hours") adjustedHours = parseFloat(amount);
      else if (unit === "days") adjustedHours = parseFloat(amount) * 8;

      const prompt = followUpText
        ? `The user has replied to your previous plan with: "${followUpText}". Re-plan accordingly with the new information. This is your final response, so please wrap up with something supportive like: 'I really hope this helps you keep moving forward. Feel free to come back again for more scheduling support!'.`
        : `You are a task planning assistant helping someone with ADHD and executive dysfunction. Be kind, encouraging and understanding, but not overly sweet or jokey. Speak plainly and helpfully, as if from someone grounded and empathetic. Use UK spelling and grammar. Here's what they said:\n\n"${text}"\n\nThey have about ${adjustedHours} hours available. Use this to generate a well-paced, realistic timeline that includes hydration, rest, and food if needed.\n\nUse markdown formatting: headings (#), bold (**bold**), and lists. Respond in clear, encouraging language.`;

      if (!fromFollowUp) {
        document.getElementById("initialInputs").classList.add("faded");
        document.getElementById("inputDetails").open = false;
      }

      const responseNumber = promptHistory.length + 1;
      const container = document.createElement("details");
      container.className = "output";
      container.open = true;
      container.innerHTML = `<summary>ðŸ“„ Response ${responseNumber}</summary><div class='spinner'></div><p class='loading'>${fromFollowUp ? 'Reviewing your responseâ€¦' : 'Thinkingâ€¦ building your timelineâ€¦'}</p>`;
      responsesDiv.appendChild(container);

      try {
        const response = await fetch("https://shy-poetry-c035.peter-775.workers.dev", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input: prompt })
        });

        const data = await response.json();
        promptHistory.push({ text, amount, unit, followUpText, answer: data.plan });

        const formatted = marked.parse(data.plan);
        const controls = `
          <div class="controls">
            <button onclick="copyText(this)">ðŸ“‹</button>
            <button onclick="downloadText(this)">ðŸ’¾</button>
          </div>
        `;
        const newReply = document.createElement("div");
        newReply.innerHTML = `${controls}${formatted}`;

        container.innerHTML = `<summary>ðŸ“„ Response ${responseNumber}</summary>`;
        container.appendChild(newReply);

        if (responseNumber === 1 && !fromFollowUp) {
          const followTextarea = document.createElement("textarea");
          const sendBtn = document.createElement("button");
          followTextarea.rows = 3;
          followTextarea.placeholder = "Want to change something or ask a follow-up? Type here.";
          sendBtn.textContent = "Send Response";
          sendBtn.onclick = () => {
            followTextarea.disabled = true;
            sendBtn.disabled = true;
            hasFollowedUp = true;
            const parentSection = sendBtn.closest("details");
            if (parentSection) parentSection.open = false;
            submitToAI(followTextarea.value.trim(), true, sendBtn);
          };
          container.appendChild(followTextarea);
          container.appendChild(sendBtn);
        } else if (responseNumber === 2 || hasFollowedUp) {
          const msg = document.createElement("p");
          msg.style.fontStyle = "italic";
          msg.style.marginTop = "1rem";
          msg.textContent = "Further responses are disabled for now.";
          container.appendChild(msg);
        }
      } catch (err) {
        container.innerHTML = `<summary>Error</summary><p class='error'>Error: ${err.message}. Please try again or check your internet connection.</p>`;
      }
    }

    function copyText(btn) {
      const text = btn.closest(".output").innerText;
      navigator.clipboard.writeText(text);
    }

    function downloadText(btn) {
      const text = btn.closest(".output").innerText;
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "timeline.txt";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>
