<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mental Dump ‚Üí Timeline</title>
  <style>
    /* Cleaned styles (omitted here for brevity) */
  </style>
</head>
<body>

  <h1>üê† Mental Dump ‚Üí Timeline</h1>
  <p class="intro">Feeling overwhelmed? This tool turns everything in your head into a clear, time-based plan that actually works for you. The more detail you give ‚Äì tasks, worries, priorities ‚Äì the better it can shape a plan that fits.</p>

  <details id="inputDetails" open>
    <summary>üì• Show/Hide Your Original Input</summary>
    <div id="initialInputs">
      <label for="freeform">What‚Äôs on your mind?</label>
      <textarea id="freeform" maxlength="1000" rows="7"></textarea>
      <div id="charCount" class="char-count">0 / 1000</div>

      <label>How much time do you have?</label>
      <div class="inline">
        <input type="number" id="timeAmount" min="1" placeholder="e.g. 3" />
        <select id="timeUnit">
          <option value="minutes">Minutes</option>
          <option value="hours">Hours</option>
          <option value="days">Days (8 working hours)</option>
        </select>
      </div>

      <button id="mainPlanButton" onclick="submitToAI()">Make My Plan</button>
    </div>
  </details>

  <div id="responses"></div>

  <script>
    let promptHistory = [];
    let hasFollowedUp = false;

    const freeform = document.getElementById("freeform");
    const charCount = document.getElementById("charCount");
    if (freeform && charCount) {
      freeform.addEventListener("input", () => {
        const len = freeform.value.length;
        charCount.textContent = `${len} / 1000`;
        charCount.classList.toggle("full", len >= 1000);
        if (len >= 1000) {
          freeform.title = "You've reached the maximum character limit.";
          freeform.value = freeform.value.substring(0, 1000);
        } else {
          freeform.removeAttribute("title");
        }
      });
    }

    async function submitToAI(followUpText = null, fromFollowUp = false) {
      const responsesDiv = document.getElementById("responses");
      const text = freeform.value.trim();
      const amount = document.getElementById("timeAmount").value.trim();
      const unit = document.getElementById("timeUnit").value;

      if (!followUpText && (!text || !amount || isNaN(amount))) {
        responsesDiv.innerHTML = "<p class='error'>Please enter your thoughts and how much time you have.</p>";
        return;
      }

      let adjustedHours = unit === "minutes" ? (parseFloat(amount) / 60).toFixed(2)
                          : unit === "days" ? parseFloat(amount) * 8
                          : parseFloat(amount);

      const now = new Date();
      const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const date = now.toLocaleDateString([], { weekday: 'long' });
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const locale = navigator.language || 'en-GB';
      const userTimeInfo = `User info: Local time is approximately ${time} on ${date}. Timezone - ${tz}, Locale - ${locale}`;

      const prompt = followUpText
        ? `The user has replied to your previous plan with: "${followUpText}". Re-plan accordingly. This is your final response.\n\n${userTimeInfo}`
        : `You are a task planning assistant. Be kind, encouraging and plainspoken. Use UK spelling.\n\nUser said: "${text}"\n\nTime available: ${adjustedHours} hours.\n\n${userTimeInfo}\n\nRespond using markdown.`;

      if (!fromFollowUp) {
        document.getElementById("initialInputs").classList.add("faded");
        document.getElementById("inputDetails").open = false;
      }

      const responseNumber = promptHistory.length + 1;
      const container = document.createElement("details");
      container.className = "output";
      container.open = true;
      container.innerHTML = `<summary>üìÑ Response ${responseNumber}</summary><div class='spinner'></div>`;
      responsesDiv.appendChild(container);

      try {
        const response = await fetch("https://your-worker-name.yourusername.workers.dev", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input: prompt })
        });

        const data = await response.json();
        promptHistory.push({ text, amount, unit, followUpText, answer: data.plan });

        const formatted = marked.parse(data.plan);
        const controls = `<div class="controls">
          <button onclick="copyText(this)">üìã</button>
          <button onclick="downloadText(this)">üìÇ</button>
        </div>`;

        const newReply = document.createElement("div");
        newReply.innerHTML = `${controls}${formatted}`;
        container.innerHTML = `<summary>üìÑ Response ${responseNumber}</summary>`;
        container.appendChild(newReply);

        if (responseNumber === 1 && !fromFollowUp) {
          const followTextarea = document.createElement("textarea");
          followTextarea.rows = 3;
          followTextarea.placeholder = "Want to change something or ask a follow-up? Type here.";

          const sendBtn = document.createElement("button");
          sendBtn.textContent = "Send Response";
          sendBtn.onclick = () => {
            followTextarea.disabled = true;
            sendBtn.disabled = true;
            hasFollowedUp = true;
            container.open = false;
            submitToAI(followTextarea.value.trim(), true);
          };

          container.appendChild(followTextarea);
          container.appendChild(sendBtn);
        } else {
          const msg = document.createElement("p");
          msg.style.fontStyle = "italic";
          msg.style.marginTop = "1rem";
          msg.textContent = "Further responses are disabled for now.";
          container.appendChild(msg);
        }
      } catch (err) {
        container.innerHTML = `<summary>Error</summary><p class='error'>Error: ${err.message}</p>`;
      }
    }

    function copyText(btn) {
      const text = btn.closest(".output").innerText;
      navigator.clipboard.writeText(text).then(() => {
        const note = document.createElement("span");
        note.textContent = "Copied to clipboard!";
        note.style.marginLeft = "0.5rem";
        note.style.color = "#90ee90";
        btn.parentNode.appendChild(note);
        setTimeout(() => note.remove(), 2000);
      });
    }

    function downloadText(btn) {
      const text = btn.closest(".output").innerText;
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const now = new Date();
      const dateStr = now.toLocaleDateString("en-GB").replace(/\//g, "-");
      const timeStr = now.toTimeString().slice(0, 5).replace(":", "-");
      const a = document.createElement("a");
      a.download = `My Timeline ${dateStr} ${timeStr}.txt`;
      a.href = url;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>
